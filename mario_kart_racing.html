<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ ãƒãƒªã‚ªã‚«ãƒ¼ãƒˆé¢¨ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚²ãƒ¼ãƒ  ğŸ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            font-family: 'Comic Sans MS', cursive, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .game-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 5px solid #fff;
        }

        canvas {
            border: 5px solid #333;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            background: linear-gradient(180deg, #87CEEB, #98FB98);
        }

        .character-selection {
            margin-bottom: 20px;
        }

        .character-option {
            display: inline-block;
            margin: 10px;
            padding: 15px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            border: 3px solid #ff6b6b;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
            font-weight: bold;
            min-width: 120px;
        }

        .character-option:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .character-option.selected {
            background: linear-gradient(45deg, #ffd93d, #ff6b6b);
            border-color: #ff0000;
            transform: scale(1.05);
        }

        .controls {
            color: #333;
            margin-top: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-weight: bold;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #fff;
        }

        .item-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffd700;
            text-align: center;
            min-width: 100px;
        }

        .item-box {
            font-size: 30px;
            margin: 5px 0;
        }

        h1 {
            color: #ff6b6b;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 200;
            border: 5px solid #fff;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .position-display {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background: rgba(255, 215, 0, 0.9);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            border: 3px solid #ff6b6b;
        }

        .speed-lines {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .minimap {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 150px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="game-container">
        <h1>ğŸ ãƒãƒªã‚ªã‚«ãƒ¼ãƒˆé¢¨ãƒ¬ãƒ¼ã‚·ãƒ³ã‚° ğŸ</h1>

        <div id="characterSelection" class="character-selection">
            <h3 style="color: #333;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼</h3>
            <div class="character-option" data-character="mario">
                <div style="font-size: 30px;">ğŸ„</div>
                <h4>ãƒãƒªã‚ª</h4>
                <p>ãƒãƒ©ãƒ³ã‚¹å‹<br>ã‚¹ãƒ”ãƒ¼ãƒ‰: â˜…â˜…â˜…â˜†â˜†<br>ã‚¢ã‚¤ãƒ†ãƒ é‹: â˜…â˜…â˜…â˜…â˜†</p>
            </div>
            <div class="character-option" data-character="luigi">
                <div style="font-size: 30px;">ğŸ‘»</div>
                <h4>ãƒ«ã‚¤ãƒ¼ã‚¸</h4>
                <p>ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯å‹<br>ã‚¹ãƒ”ãƒ¼ãƒ‰: â˜…â˜…â˜…â˜…â˜†<br>ã‚¢ã‚¤ãƒ†ãƒ é‹: â˜…â˜…â˜…â˜†â˜†</p>
            </div>
            <div class="character-option" data-character="peach">
                <div style="font-size: 30px;">ğŸ‘‘</div>
                <h4>ãƒ”ãƒ¼ãƒ</h4>
                <p>ã‚¢ã‚¤ãƒ†ãƒ å‹<br>ã‚¹ãƒ”ãƒ¼ãƒ‰: â˜…â˜…â˜†â˜†â˜†<br>ã‚¢ã‚¤ãƒ†ãƒ é‹: â˜…â˜…â˜…â˜…â˜…</p>
            </div>
            <div class="character-option" data-character="bowser">
                <div style="font-size: 30px;">ğŸ”¥</div>
                <h4>ã‚¯ãƒƒãƒ‘</h4>
                <p>ãƒ‘ãƒ¯ãƒ¼å‹<br>ã‚¹ãƒ”ãƒ¼ãƒ‰: â˜…â˜…â˜…â˜…â˜…<br>ã‚¢ã‚¤ãƒ†ãƒ é‹: â˜…â˜…â˜†â˜†â˜†</p>
            </div>
            <div class="character-option" data-character="yoshi">
                <div style="font-size: 30px;">ğŸ¦•</div>
                <h4>ãƒ¨ãƒƒã‚·ãƒ¼</h4>
                <p>ã‚¹ãƒ”ãƒ¼ãƒ‰å‹<br>ã‚¹ãƒ”ãƒ¼ãƒ‰: â˜…â˜…â˜…â˜…â˜…<br>ã‚¢ã‚¤ãƒ†ãƒ é‹: â˜…â˜…â˜…â˜†â˜†</p>
            </div>
            <div class="character-option" data-character="toad">
                <div style="font-size: 30px;">ğŸ„</div>
                <h4>ã‚­ãƒãƒ”ã‚ª</h4>
                <p>è»½é‡å‹<br>ã‚¹ãƒ”ãƒ¼ãƒ‰: â˜…â˜…â˜…â˜†â˜†<br>ã‚¢ã‚¤ãƒ†ãƒ é‹: â˜…â˜…â˜…â˜…â˜†</p>
            </div>
            <br>
            <button onclick="startRace()">ğŸ ãƒ¬ãƒ¼ã‚¹é–‹å§‹ï¼ ğŸ</button>
        </div>

        <div id="gameArea" style="display: none; position: relative;">
            <div class="ui-overlay">
                <div>ğŸ† é †ä½: <span id="position">1</span>/8</div>
                <div>â­ ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
                <div>ğŸ ãƒ©ãƒƒãƒ—: <span id="lap">1</span>/3</div>
                <div>ğŸ’¨ ã‚¹ãƒ”ãƒ¼ãƒ‰: <span id="speed">0</span> km/h</div>
            </div>

            <div class="item-display">
                <div>ã‚¢ã‚¤ãƒ†ãƒ </div>
                <div id="currentItem" class="item-box">â“</div>
                <div id="itemName">ãªã—</div>
            </div>

            <div class="position-display">
                <div id="positionLarge">1st</div>
            </div>

            <canvas id="gameCanvas" width="900" height="600"></canvas>
            <canvas id="minimap" class="minimap" width="150" height="100"></canvas>

            <div class="controls">
                <p>ğŸ® æ“ä½œ: â†‘â†“â†â†’ ç§»å‹• | ã‚¹ãƒšãƒ¼ã‚¹: ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨ | Shift: ãƒ‰ãƒªãƒ•ãƒˆ</p>
            </div>
        </div>

        <div id="gameOver" class="game-over" style="display: none;">
            <h2>ğŸ ãƒ¬ãƒ¼ã‚¹çµ‚äº†ï¼ ğŸ</h2>
            <div id="finalPosition" style="font-size: 48px; margin: 20px 0;"></div>
            <p>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></p>
            <p>å®Œèµ°ãƒ©ãƒƒãƒ—: <span id="finalLap">0</span>/3</p>
            <button onclick="restartRace()">ğŸ”„ ã‚‚ã†ä¸€åº¦ãƒ¬ãƒ¼ã‚¹ï¼</button>
            <button onclick="backToSelection()">ğŸ‘¥ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ è¨­å®š
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimap');
        const minimapCtx = minimapCanvas.getContext('2d');

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
        const characters = {
            mario: {
                name: 'ãƒãƒªã‚ª',
                emoji: 'ğŸ„',
                color: '#ff0000',
                maxSpeed: 6,
                acceleration: 0.4,
                itemLuck: 0.8,
                weight: 3
            },
            luigi: {
                name: 'ãƒ«ã‚¤ãƒ¼ã‚¸',
                emoji: 'ğŸ‘»',
                color: '#00ff00',
                maxSpeed: 7,
                acceleration: 0.5,
                itemLuck: 0.6,
                weight: 3
            },
            peach: {
                name: 'ãƒ”ãƒ¼ãƒ',
                emoji: 'ğŸ‘‘',
                color: '#ffb6c1',
                maxSpeed: 5,
                acceleration: 0.3,
                itemLuck: 1.0,
                weight: 2
            },
            bowser: {
                name: 'ã‚¯ãƒƒãƒ‘',
                emoji: 'ğŸ”¥',
                color: '#8b4513',
                maxSpeed: 8,
                acceleration: 0.6,
                itemLuck: 0.4,
                weight: 5
            },
            yoshi: {
                name: 'ãƒ¨ãƒƒã‚·ãƒ¼',
                emoji: 'ğŸ¦•',
                color: '#32cd32',
                maxSpeed: 8,
                acceleration: 0.7,
                itemLuck: 0.6,
                weight: 2
            },
            toad: {
                name: 'ã‚­ãƒãƒ”ã‚ª',
                emoji: 'ğŸ„',
                color: '#ff69b4',
                maxSpeed: 6,
                acceleration: 0.5,
                itemLuck: 0.8,
                weight: 1
            }
        };

        // ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿
        const items = {
            mushroom: { name: 'ã‚­ãƒã‚³', emoji: 'ğŸ„', effect: 'speed_boost' },
            shell: { name: 'ã‚³ã‚¦ãƒ©', emoji: 'ğŸ¢', effect: 'projectile' },
            banana: { name: 'ãƒãƒŠãƒŠ', emoji: 'ğŸŒ', effect: 'trap' },
            star: { name: 'ã‚¹ã‚¿ãƒ¼', emoji: 'â­', effect: 'invincible' },
            lightning: { name: 'ã‚«ãƒŸãƒŠãƒª', emoji: 'âš¡', effect: 'shrink_others' },
            bomb: { name: 'ãƒœãƒ ', emoji: 'ğŸ’£', effect: 'explosion' }
        };

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            selectedCharacter: null,
            player: null,
            cpuRacers: [],
            itemBoxes: [],
            projectiles: [],
            traps: [],
            currentItem: null,
            score: 0,
            lap: 1,
            position: 1,
            gameRunning: false,
            keys: {},
            trackOffset: 0,
            raceDistance: 0,
            totalRacers: 8,
            driftBonus: 0,
            speedBoostTimer: 0,
            invincibleTimer: 0
        };

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹
        class Player {
            constructor(characterType) {
                this.character = characters[characterType];
                this.x = canvas.width / 2;
                this.y = canvas.height - 120;
                this.speed = 0;
                this.maxSpeed = this.character.maxSpeed;
                this.acceleration = this.character.acceleration;
                this.width = 45;
                this.height = 65;
                this.angle = 0;
                this.drifting = false;
                this.invulnerable = false;
                this.stunned = false;
                this.raceProgress = 0;
            }

            update() {
                // ç§»å‹•å‡¦ç†
                let targetSpeed = 0;
                if (gameState.keys['ArrowUp'] && !this.stunned) {
                    targetSpeed = this.maxSpeed + (gameState.speedBoostTimer > 0 ? 3 : 0);
                } else if (gameState.keys['ArrowDown']) {
                    targetSpeed = -this.maxSpeed / 2;
                }

                // ã‚¹ãƒ”ãƒ¼ãƒ‰èª¿æ•´
                if (this.speed < targetSpeed) {
                    this.speed = Math.min(this.speed + this.acceleration, targetSpeed);
                } else if (this.speed > targetSpeed) {
                    this.speed = Math.max(this.speed - this.acceleration * 1.5, targetSpeed);
                }

                // å·¦å³ç§»å‹•
                if (gameState.keys['ArrowLeft'] && !this.stunned) {
                    this.x = Math.max(this.x - 6, 100);
                    this.angle = -0.2;
                }
                if (gameState.keys['ArrowRight'] && !this.stunned) {
                    this.x = Math.min(this.x + 6, canvas.width - 100);
                    this.angle = 0.2;
                }

                // ãƒ‰ãƒªãƒ•ãƒˆå‡¦ç†
                if (gameState.keys['ShiftLeft'] && (gameState.keys['ArrowLeft'] || gameState.keys['ArrowRight'])) {
                    this.drifting = true;
                    gameState.driftBonus = Math.min(gameState.driftBonus + 1, 100);
                } else {
                    if (this.drifting && gameState.driftBonus > 30) {
                        // ãƒ‰ãƒªãƒ•ãƒˆãƒœãƒ¼ãƒŠã‚¹
                        gameState.speedBoostTimer = 120; // 2ç§’é–“ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—
                    }
                    this.drifting = false;
                    gameState.driftBonus = 0;
                }

                // è§’åº¦ãƒªã‚»ãƒƒãƒˆ
                if (!gameState.keys['ArrowLeft'] && !gameState.keys['ArrowRight']) {
                    this.angle *= 0.8;
                }

                // ãƒ¬ãƒ¼ã‚¹é€²è¡Œåº¦æ›´æ–°
                this.raceProgress += this.speed;
                gameState.raceDistance = this.raceProgress;

                // ã‚¹ã‚³ã‚¢å¢—åŠ 
                gameState.score += Math.floor(this.speed * 10);

                // ã‚¿ã‚¤ãƒãƒ¼æ¸›å°‘
                if (gameState.speedBoostTimer > 0) gameState.speedBoostTimer--;
                if (gameState.invincibleTimer > 0) gameState.invincibleTimer--;
                if (this.stunned) this.stunned--;

                // ãƒ©ãƒƒãƒ—åˆ¤å®š
                if (this.raceProgress > 0 && this.raceProgress % 8000 < this.speed) {
                    gameState.lap = Math.min(gameState.lap + 1, 3);
                    if (gameState.lap > 3) {
                        endRace();
                    }
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);

                // ç„¡æ•µçŠ¶æ…‹ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                if (gameState.invincibleTimer > 0) {
                    ctx.shadowColor = '#ffd700';
                    ctx.shadowBlur = 20;
                }

                // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                if (gameState.speedBoostTimer > 0) {
                    ctx.shadowColor = '#ff4500';
                    ctx.shadowBlur = 15;
                }

                // è»Šä½“
                ctx.fillStyle = this.character.color;
                ctx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);

                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çµµæ–‡å­—
                ctx.font = '30px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.character.emoji, 0, 5);

                // ãƒ‰ãƒªãƒ•ãƒˆç…™ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                if (this.drifting) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.arc(-20 + Math.random() * 40, 35 + i * 10, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                ctx.restore();
                ctx.shadowBlur = 0;
            }
        }

        // CPUãƒ¬ãƒ¼ã‚µãƒ¼ã‚¯ãƒ©ã‚¹
        class CPURacer {
            constructor(characterType, startX) {
                this.character = characters[characterType];
                this.x = startX;
                this.y = canvas.height - 200 - Math.random() * 100;
                this.speed = this.character.maxSpeed * (0.7 + Math.random() * 0.4);
                this.maxSpeed = this.character.maxSpeed;
                this.width = 40;
                this.height = 60;
                this.raceProgress = Math.random() * 100;
                this.aiTimer = 0;
                this.targetX = startX;
                this.stunned = 0;
            }

            update() {
                if (this.stunned > 0) {
                    this.stunned--;
                    this.speed *= 0.5;
                    return;
                }

                // ç°¡å˜ãªAI
                this.aiTimer++;
                if (this.aiTimer % 60 === 0) {
                    this.targetX = 150 + Math.random() * (canvas.width - 300);
                }

                // ç›®æ¨™ä½ç½®ã«å‘ã‹ã£ã¦ç§»å‹•
                if (this.x < this.targetX) {
                    this.x = Math.min(this.x + 3, this.targetX);
                } else if (this.x > this.targetX) {
                    this.x = Math.max(this.x - 3, this.targetX);
                }

                // ãƒ¬ãƒ¼ã‚¹é€²è¡Œ
                this.raceProgress += this.speed;

                // ã‚¹ãƒ”ãƒ¼ãƒ‰èª¿æ•´
                this.speed = this.maxSpeed * (0.8 + Math.random() * 0.3);
            }

            draw() {
                ctx.fillStyle = this.character.color;
                ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);

                // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çµµæ–‡å­—
                ctx.font = '25px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = 'black';
                ctx.fillText(this.character.emoji, this.x, this.y + 5);
            }
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒ©ã‚¹
        class ItemBox {
            constructor() {
                this.x = 200 + Math.random() * (canvas.width - 400);
                this.y = -50;
                this.width = 40;
                this.height = 40;
                this.rotation = 0;
                this.collected = false;
            }

            update() {
                this.y += 4 + gameState.trackOffset;
                this.rotation += 0.1;
            }

            draw() {
                if (this.collected) return;

                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);

                // ã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒƒã‚¯ã‚¹
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);
                ctx.strokeStyle = '#ff8c00';
                ctx.lineWidth = 3;
                ctx.strokeRect(-this.width / 2, -this.height / 2, this.width, this.height);

                // ï¼Ÿãƒãƒ¼ã‚¯
                ctx.fillStyle = '#ff0000';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('?', 0, 8);

                ctx.restore();
            }
        }

        // ç™ºå°„ç‰©ã‚¯ãƒ©ã‚¹
        class Projectile {
            constructor(x, y, targetY) {
                this.x = x;
                this.y = y;
                this.targetY = targetY;
                this.speed = 8;
                this.width = 30;
                this.height = 30;
                this.type = 'shell';
            }

            update() {
                this.y += this.speed;
            }

            draw() {
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 15, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = 'black';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ¢', this.x, this.y + 5);
            }
        }

        // ãƒˆãƒ©ãƒƒãƒ—ã‚¯ãƒ©ã‚¹
        class Trap {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 35;
                this.height = 35;
                this.lifetime = 300; // 5ç§’
            }

            update() {
                this.y += gameState.trackOffset;
                this.lifetime--;
            }

            draw() {
                if (this.lifetime <= 0) return;

                ctx.font = '30px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸŒ', this.x, this.y);
            }
        }

        // è¡çªåˆ¤å®š
        function checkCollision(obj1, obj2) {
            return obj1.x - obj1.width / 2 < obj2.x + obj2.width / 2 &&
                obj1.x + obj1.width / 2 > obj2.x - obj2.width / 2 &&
                obj1.y - obj1.height / 2 < obj2.y + obj2.height / 2 &&
                obj1.y + obj1.height / 2 > obj2.y - obj2.height / 2;
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨
        function useItem() {
            if (!gameState.currentItem) return;

            const item = gameState.currentItem;

            switch (item.effect) {
                case 'speed_boost':
                    gameState.speedBoostTimer = 180; // 3ç§’é–“
                    break;

                case 'projectile':
                    gameState.projectiles.push(new Projectile(
                        gameState.player.x,
                        gameState.player.y - 50,
                        gameState.player.y - 200
                    ));
                    break;

                case 'trap':
                    gameState.traps.push(new Trap(
                        gameState.player.x,
                        gameState.player.y + 50
                    ));
                    break;

                case 'invincible':
                    gameState.invincibleTimer = 300; // 5ç§’é–“
                    break;

                case 'shrink_others':
                    gameState.cpuRacers.forEach(cpu => {
                        cpu.stunned = 180; // 3ç§’é–“
                    });
                    break;

                case 'explosion':
                    // å‘¨å›²ã®æ•µã‚’å¹ãé£›ã°ã™
                    gameState.cpuRacers.forEach(cpu => {
                        const distance = Math.abs(cpu.x - gameState.player.x) + Math.abs(cpu.y - gameState.player.y);
                        if (distance < 150) {
                            cpu.stunned = 120;
                        }
                    });
                    break;
            }

            gameState.currentItem = null;
            updateItemDisplay();
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ã‚¤ãƒ†ãƒ å–å¾—
        function getRandomItem() {
            const itemKeys = Object.keys(items);
            const luck = gameState.player.character.itemLuck;

            // é‹ã«ã‚ˆã£ã¦ãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ ã®ç¢ºç‡ã‚’èª¿æ•´
            let availableItems = itemKeys;
            if (Math.random() > luck) {
                availableItems = itemKeys.filter(key =>
                    key !== 'star' && key !== 'lightning' && key !== 'bomb'
                );
            }

            const randomKey = availableItems[Math.floor(Math.random() * availableItems.length)];
            return items[randomKey];
        }

        // é †ä½è¨ˆç®—
        function calculatePosition() {
            const allRacers = [gameState.player, ...gameState.cpuRacers];
            allRacers.sort((a, b) => b.raceProgress - a.raceProgress);

            const playerIndex = allRacers.indexOf(gameState.player);
            gameState.position = playerIndex + 1;
        }

        // é“è·¯ã¨ã‚³ãƒ¼ã‚¹æç”»
        function drawTrack() {
            // èƒŒæ™¯ï¼ˆè‰åŸï¼‰
            ctx.fillStyle = '#90EE90';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // é“è·¯
            ctx.fillStyle = '#696969';
            ctx.fillRect(100, 0, canvas.width - 200, canvas.height);

            // é“è·¯ã®å¢ƒç•Œç·š
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(100, 0, 8, canvas.height);
            ctx.fillRect(canvas.width - 108, 0, 8, canvas.height);

            // ä¸­å¤®ç·š
            ctx.fillStyle = '#FFFF00';
            for (let i = 0; i < canvas.height; i += 60) {
                const offset = (gameState.trackOffset * 3) % 60;
                ctx.fillRect(canvas.width / 2 - 3, i - offset, 6, 30);
            }

            // ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ•ãƒ©ãƒƒã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚´ãƒ¼ãƒ«ä»˜è¿‘ï¼‰
            if (gameState.lap === 3 && gameState.raceDistance % 8000 > 7500) {
                for (let x = 100; x < canvas.width - 100; x += 40) {
                    for (let y = 0; y < canvas.height; y += 40) {
                        ctx.fillStyle = ((x + y) / 40) % 2 === 0 ? '#000' : '#fff';
                        ctx.fillRect(x, y, 40, 40);
                    }
                }
            }
        }

        // UIæ›´æ–°
        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('lap').textContent = gameState.lap;
            document.getElementById('position').textContent = gameState.position;
            document.getElementById('speed').textContent = Math.floor(gameState.player.speed * 20);

            // é †ä½è¡¨ç¤º
            const positions = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th'];
            document.getElementById('positionLarge').textContent = positions[gameState.position - 1] || '8th';

            // é †ä½ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
            const positionElement = document.getElementById('positionLarge');
            if (gameState.position === 1) {
                positionElement.style.color = '#ffd700';
            } else if (gameState.position <= 3) {
                positionElement.style.color = '#c0c0c0';
            } else {
                positionElement.style.color = '#cd7f32';
            }
        }

        // ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤ºæ›´æ–°
        function updateItemDisplay() {
            const itemBox = document.getElementById('currentItem');
            const itemName = document.getElementById('itemName');

            if (gameState.currentItem) {
                itemBox.textContent = gameState.currentItem.emoji;
                itemName.textContent = gameState.currentItem.name;
            } else {
                itemBox.textContent = 'â“';
                itemName.textContent = 'ãªã—';
            }
        }

        // ãƒŸãƒ‹ãƒãƒƒãƒ—æç”»
        function drawMinimap() {
            minimapCtx.fillStyle = '#90EE90';
            minimapCtx.fillRect(0, 0, 150, 100);

            // ãƒˆãƒ©ãƒƒã‚¯
            minimapCtx.fillStyle = '#696969';
            minimapCtx.fillRect(20, 0, 110, 100);

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            minimapCtx.fillStyle = '#ff0000';
            minimapCtx.fillRect(70, 80, 10, 10);

            // CPU
            gameState.cpuRacers.forEach((cpu, index) => {
                minimapCtx.fillStyle = cpu.character.color;
                const y = 80 - (cpu.raceProgress - gameState.player.raceProgress) * 0.01;
                minimapCtx.fillRect(25 + (index % 10) * 10, Math.max(0, Math.min(90, y)), 8, 8);
            });
        }

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            if (!gameState.gameRunning) return;

            // ç”»é¢ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ãƒˆãƒ©ãƒƒã‚¯æç”»
            drawTrack();

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°ãƒ»æç”»
            gameState.player.update();
            gameState.player.draw();

            // CPUæ›´æ–°ãƒ»æç”»
            gameState.cpuRacers.forEach(cpu => {
                cpu.update();
                cpu.draw();
            });

            // ã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
            if (Math.random() < 0.02) {
                gameState.itemBoxes.push(new ItemBox());
            }

            // ã‚¢ã‚¤ãƒ†ãƒ ãƒœãƒƒã‚¯ã‚¹æ›´æ–°ãƒ»æç”»ãƒ»è¡çªåˆ¤å®š
            gameState.itemBoxes = gameState.itemBoxes.filter(box => {
                box.update();
                box.draw();

                if (!box.collected && checkCollision(gameState.player, box)) {
                    box.collected = true;
                    if (!gameState.currentItem) {
                        gameState.currentItem = getRandomItem();
                        updateItemDisplay();
                    }
                    gameState.score += 100;
                    return false;
                }

                return box.y < canvas.height + 100;
            });

            // ç™ºå°„ç‰©æ›´æ–°ãƒ»æç”»
            gameState.projectiles = gameState.projectiles.filter(projectile => {
                projectile.update();
                projectile.draw();

                // CPU ã¨ã®è¡çªåˆ¤å®š
                gameState.cpuRacers.forEach(cpu => {
                    if (checkCollision(projectile, cpu)) {
                        cpu.stunned = 120;
                        gameState.score += 200;
                    }
                });

                return projectile.y < canvas.height + 100;
            });

            // ãƒˆãƒ©ãƒƒãƒ—æ›´æ–°ãƒ»æç”»
            gameState.traps = gameState.traps.filter(trap => {
                trap.update();
                trap.draw();

                // CPU ã¨ã®è¡çªåˆ¤å®š
                gameState.cpuRacers.forEach(cpu => {
                    if (checkCollision(trap, cpu)) {
                        cpu.stunned = 90;
                        trap.lifetime = 0;
                    }
                });

                return trap.lifetime > 0 && trap.y < canvas.height + 100;
            });

            // é †ä½è¨ˆç®—
            calculatePosition();

            // UIæ›´æ–°
            updateUI();

            // ãƒŸãƒ‹ãƒãƒƒãƒ—æ›´æ–°
            drawMinimap();

            // ãƒˆãƒ©ãƒƒã‚¯ã‚ªãƒ•ã‚»ãƒƒãƒˆæ›´æ–°
            gameState.trackOffset = gameState.player.speed;

            requestAnimationFrame(gameLoop);
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
        document.querySelectorAll('.character-option').forEach(option => {
            option.addEventListener('click', function () {
                document.querySelectorAll('.character-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                gameState.selectedCharacter = this.dataset.character;
            });
        });

        // ãƒ¬ãƒ¼ã‚¹é–‹å§‹
        function startRace() {
            if (!gameState.selectedCharacter) {
                alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼');
                return;
            }

            document.getElementById('characterSelection').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';

            // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
            gameState.player = new Player(gameState.selectedCharacter);
            gameState.cpuRacers = [];

            // CPU ãƒ¬ãƒ¼ã‚µãƒ¼ç”Ÿæˆ
            const availableCharacters = Object.keys(characters).filter(char => char !== gameState.selectedCharacter);
            for (let i = 0; i < 7; i++) {
                const charType = availableCharacters[i % availableCharacters.length];
                gameState.cpuRacers.push(new CPURacer(charType, 200 + i * 80));
            }

            gameState.itemBoxes = [];
            gameState.projectiles = [];
            gameState.traps = [];
            gameState.currentItem = null;
            gameState.score = 0;
            gameState.lap = 1;
            gameState.position = Math.floor(Math.random() * 4) + 3; // 3-6ä½ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
            gameState.gameRunning = true;
            gameState.trackOffset = 0;
            gameState.raceDistance = 0;
            gameState.speedBoostTimer = 0;
            gameState.invincibleTimer = 0;

            updateItemDisplay();
            gameLoop();
        }

        // ãƒ¬ãƒ¼ã‚¹çµ‚äº†
        function endRace() {
            gameState.gameRunning = false;
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalLap').textContent = gameState.lap;

            // æœ€çµ‚é †ä½è¡¨ç¤º
            const positions = ['ğŸ¥‡ 1ä½ï¼', 'ğŸ¥ˆ 2ä½ï¼', 'ğŸ¥‰ 3ä½ï¼', '4ä½', '5ä½', '6ä½', '7ä½', '8ä½'];
            document.getElementById('finalPosition').textContent = positions[gameState.position - 1] || '8ä½';

            document.getElementById('gameOver').style.display = 'block';
        }

        // ãƒ¬ãƒ¼ã‚¹å†é–‹
        function restartRace() {
            document.getElementById('gameOver').style.display = 'none';
            startRace();
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã«æˆ»ã‚‹
        function backToSelection() {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('characterSelection').style.display = 'block';

            // é¸æŠãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.character-option').forEach(opt => opt.classList.remove('selected'));
            gameState.selectedCharacter = null;
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('keydown', function (e) {
            gameState.keys[e.code] = true;

            if (e.code === 'Space' && gameState.gameRunning) {
                e.preventDefault();
                useItem();
            }
        });

        document.addEventListener('keyup', function (e) {
            gameState.keys[e.code] = false;
        });

        // åˆæœŸåŒ–
        updateItemDisplay();
    </script>
</body>

</html>